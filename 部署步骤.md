# 🚀 Cloudflare 部署步骤

## 第一步：部署 Worker（后端）

### 1. 安装依赖并登录

打开终端（PowerShell），在项目目录运行：

```powershell
# 进入项目目录
cd C:\Users\admin\Desktop\CF

# 安装依赖
npm install

# 登录到 Cloudflare（会打开浏览器让你授权）
npx wrangler login
```

### 2. 创建 KV 数据库

```powershell
# 创建生产环境 KV
npx wrangler kv:namespace create "URL_DB"

# 创建预览环境 KV
npx wrangler kv:namespace create "URL_DB" --preview
```

你会看到类似这样的输出：
```
⛅️ wrangler 3.x.x
-------------------
🌀 Creating namespace with title "cf-url-shortener-URL_DB"
✨ Success!
Add the following to your configuration file in your kv_namespaces array:
{ binding = "URL_DB", id = "abc123def456..." }

⛅️ wrangler 3.x.x
-------------------
🌀 Creating namespace with title "cf-url-shortener-URL_DB_preview"
✨ Success!
Add the following to your configuration file in your kv_namespaces array:
{ binding = "URL_DB", preview_id = "xyz789abc123..." }
```

**重要：复制这两个 ID！**

### 3. 更新 wrangler.toml

用记事本或编辑器打开 `wrangler.toml`，修改以下内容：

```toml
name = "cf-url-shortener"
main = "src/index.js"
compatibility_date = "2024-01-01"

# KV Namespace binding
[[kv_namespaces]]
binding = "URL_DB"
id = "粘贴这里：生产环境的ID"
preview_id = "粘贴这里：预览环境的ID"

# Environment variables
[vars]
ADMIN_TOKEN = "设置一个强密码，例如：MySecureToken123456"
BASE_URL = "https://cf-url-shortener.你的用户名.workers.dev"

# Production environment (optional)
[env.production]
name = "cf-url-shortener-prod"
```

### 4. 部署 Worker

```powershell
npm run deploy
```

部署成功后，你会看到：
```
✨ Success! Uploaded 1 files (x.xx sec)
Published cf-url-shortener (x.xx sec)
  https://cf-url-shortener.你的用户名.workers.dev
```

**复制这个 URL！这是你的 Worker API 地址。**

### 5. 测试 Worker API

在浏览器访问：
```
https://cf-url-shortener.你的用户名.workers.dev
```

你应该看到 API 信息。

---

## 第二步：部署 Pages（前端）

### 方法 A：通过 Cloudflare Dashboard（推荐）

1. **更新前端 API 地址**

在部署 Pages 之前，先更新前端的 API 地址。

编辑以下三个文件，将 `const API_BASE = window.location.origin;` 改为你的 Worker URL：

- `public/index.html`
- `public/admin.html`
- `public/stats.html`

找到这行：
```javascript
const API_BASE = window.location.origin;
```

改为：
```javascript
const API_BASE = 'https://cf-url-shortener.你的用户名.workers.dev';
```

保存后提交到 GitHub：
```powershell
git add .
git commit -m "Update API endpoint"
git push
```

2. **在 Cloudflare 创建 Pages 项目**

- 访问：https://dash.cloudflare.com/
- 点击左侧菜单 **Workers & Pages**
- 点击 **Create application**
- 选择 **Pages** 选项卡
- 点击 **Connect to Git**

3. **连接 GitHub 仓库**

- 选择你的 GitHub 账户
- 选择 `cf-url-shortener` 仓库
- 点击 **Begin setup**

4. **配置构建设置**

```
Project name: cf-url-shortener
Production branch: main
Build command: （留空）
Build output directory: public
```

5. **点击 "Save and Deploy"**

等待几分钟，部署完成后你会得到一个 URL：
```
https://cf-url-shortener.pages.dev
```

---

## 第三步：测试完整功能

### 1. 测试前端

访问你的 Pages URL：
```
https://cf-url-shortener.pages.dev
```

### 2. 创建短链接

- 输入一个长 URL，例如：`https://www.cloudflare.com`
- 点击 "Shorten URL"
- 复制生成的短链接

### 3. 测试短链接

访问生成的短链接，应该会重定向到原始 URL。

### 4. 测试管理面板

访问：
```
https://cf-url-shortener.pages.dev/admin.html
```

输入你在 `wrangler.toml` 中设置的 `ADMIN_TOKEN`，应该能看到所有链接列表。

---

## 方法 B：命令行部署 Pages（备选）

如果你不想使用 GitHub 自动部署，可以直接部署：

```powershell
# 首先更新 API 地址（同上）
# 然后直接部署 public 目录

npx wrangler pages deploy public --project-name=cf-url-shortener
```

---

## 🎉 完成！

你的 URL 短链接服务现在已经完全部署好了！

- 🌐 **前端地址**：https://cf-url-shortener.pages.dev
- 🔗 **API 地址**：https://cf-url-shortener.你的用户名.workers.dev
- 👑 **管理面板**：https://cf-url-shortener.pages.dev/admin.html

---

## 📝 重要提醒

1. ✅ 记住你的 ADMIN_TOKEN
2. ✅ Worker URL 和 Pages URL 都已准备好
3. ✅ 前端的 API_BASE 已更新为 Worker URL
4. ✅ 可以开始使用了！

---

## 🔧 常见问题

**Q: 提示 "KV namespace not found"**
A: 确保 `wrangler.toml` 中的 KV ID 已正确填写

**Q: 前端无法创建短链接**
A: 检查前端文件中的 `API_BASE` 是否指向正确的 Worker URL

**Q: 管理面板提示 "Unauthorized"**
A: 确认输入的 ADMIN_TOKEN 与 `wrangler.toml` 中设置的一致

**Q: 需要自定义域名**
A: 在 Cloudflare Dashboard 中可以为 Worker 和 Pages 分别添加自定义域名

